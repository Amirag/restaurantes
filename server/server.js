!function(e){function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var r={};t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=44)}([function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var a=r(7),i=n(a),o=r(6),s=n(o),u={env:process.env.NODE_ENV||"development",root:i.default.normalize(__dirname+"/.."),port:process.env.PORT||8080,secrets:{session:process.env.APP_SECRET},cloudinaryConfig:{cloud_name:process.env.CLOUDINARY_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET},tiposNodos:["restaurante","categoria","platillo"]};e.exports=s.default.merge(u,r(8),r(46)("./"+process.env.NODE_ENV+".js")||{})},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var a=r(4),i=n(a),o=r(0),s=n(o),u="mysql://"+s.default.sequelize.user+":"+s.default.sequelize.password+"@"+s.default.sequelize.address+"/"+s.default.sequelize.name,d={Sequelize:i.default,sequelize:new i.default(u,s.default.sequelize.options)};d.User=d.sequelize.import("User",r(35)),d.NewUser=d.sequelize.import("NewUser",r(36)),d.Recuperacion=d.sequelize.import("Recuperacion",r(32)),d.MenuPaths=d.sequelize.import("MenuPaths",r(26)),d.MenuNodes=d.sequelize.import("MenuNodes",r(25)),d.Restaurante=d.sequelize.import("Restaurante",r(29)),d.Platillo=d.sequelize.import("Platillo",r(28)),d.Categoria=d.sequelize.import("Categoria",r(20)),d.Visita=d.sequelize.import("Visita",r(37)),d.MenuLikes=d.sequelize.import("MenuLikes",r(24)),d.MenuAdmin=d.sequelize.import("MenuAdmin",r(22)),d.Estado=d.sequelize.import("Estado",r(18)),d.Ciudad=d.sequelize.import("Ciudad",r(15)),d.User.hasMany(d.User,{foreignKey:"authorId"}),d.User.hasMany(d.Recuperacion,{foreignKey:"userId"}),d.Recuperacion.belongsTo(d.User,{foreignKey:"userId"}),d.User.hasMany(d.MenuNodes,{foreignKey:"authorId"}),d.MenuNodes.belongsTo(d.User,{foreignKey:"authorId"}),d.User.hasMany(d.MenuNodes,{foreignKey:"editorId"}),d.MenuNodes.belongsTo(d.User,{foreignKey:"editorId"}),d.MenuNodes.hasMany(d.MenuPaths,{foreignKey:"parent"}),d.MenuPaths.belongsTo(d.MenuNodes,{foreignKey:"parent"}),d.MenuNodes.hasMany(d.MenuPaths,{foreignKey:"descendant"}),d.MenuPaths.belongsTo(d.MenuNodes,{foreignKey:"descendant"}),d.MenuNodes.hasMany(d.Restaurante,{foreignKey:"_id"}),d.Restaurante.belongsTo(d.MenuNodes,{foreignKey:"_id"}),d.MenuNodes.hasMany(d.Platillo,{foreignKey:"_id"}),d.Platillo.belongsTo(d.MenuNodes,{foreignKey:"_id"}),d.MenuNodes.hasMany(d.Categoria,{foreignKey:"_id"}),d.Categoria.belongsTo(d.MenuNodes,{foreignKey:"_id"}),d.Estado.hasMany(d.Ciudad,{foreignKey:"stateId"}),d.Ciudad.belongsTo(d.Estado,{foreignKey:"stateId"}),d.User.hasMany(d.Estado,{foreignKey:"authorId"}),d.Estado.belongsTo(d.User,{foreignKey:"authorId"}),d.User.hasMany(d.Ciudad,{foreignKey:"authorId"}),d.Ciudad.belongsTo(d.User,{foreignKey:"authorId"}),d.Restaurante.hasMany(d.Visita,{foreignKey:"restauranteId"}),d.Visita.belongsTo(d.Restaurante,{foreignKey:"restauranteId"}),d.Restaurante.belongsToMany(d.User,{through:d.MenuLikes,foreignKey:"restauranteId"}),d.User.belongsToMany(d.Restaurante,{through:d.MenuLikes,foreignKey:"userId"}),d.Restaurante.belongsToMany(d.User,{through:d.MenuAdmin,foreignKey:"restauranteId"}),d.User.belongsToMany(d.Restaurante,{through:d.MenuAdmin,foreignKey:"userId"}),e.exports=d},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:422;return function(r){return e.status(t).send(r)}}function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return function(r){return e.status(t).send(r)}}function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return function(r){return r?e.status(t).send(r):null}}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:404;return function(r){return r||(e.status(t).end(),null)}}function u(e,t,r){var n={count:0,data:[]};return E.default.sequelize.query(e,{replacements:r,type:E.default.Sequelize.QueryTypes.SELECT}).then(function(e){return e&&e[0]&&e[0].count&&(n.count=e[0].count),E.default.sequelize.query(t,{replacements:r,type:E.default.Sequelize.QueryTypes.SELECT})}).then(function(e){return n.data=e,n})}function d(e,t){return new Promise(function(r,n){N.default.uploader.upload(e,function(e,t){t&&n(t),r(e)},t)})}function l(e){return new Promise(function(t,r){N.default.uploader.destroy(e,function(e,n){n&&r(n),t(e)})})}function c(e){return function(t,r,n){return t._errors||(t._errors=[]),t.params&&t.params[e]?((isNaN(t.params[e])||(0^t.params[e])!=+t.params[e])&&t._errors.push({message:"El identificador "+e+" no es válido",type:"Validation error",path:"id",value:t.params[e],raw:{}}),t.params[e]=+t.params[e],n()):(t._errors.push({message:"El identificador "+e+" no fue encontrado",type:"Validation error",path:"id",value:"",raw:{}}),n())}}function h(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:400;return function(t,r,n){return t._errors&&t._errors.length>0?r.status(e).send(t._errors):n()}}Object.defineProperty(t,"__esModule",{value:!0}),t.validationError=a,t.handleError=i,t.respondWithResult=o,t.handleEntityNotFound=s,t.pagination=u,t.cloud=d,t.cloudDelete=l,t.checkIdFromParams=c,t.checkIfErrors=h;var p=r(0),f=n(p),m=r(1),E=n(m),y=r(48),N=n(y);N.default.config(f.default.cloudinaryConfig)},function(e,t){e.exports=require("sequelize")},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(){return(0,A.default)().use(function(e,t,r){return void 0===e.headers.authorization?r():T(e,t,r)}).use(function(e,t,r){return e.user?_.User.findOne({where:{_id:e.user._id,deletedAt:null}}).then(function(n){return n?(e.user=n,r()):t.status(401).end()}).catch(function(e){return r(e)}):r()})}function i(){return(0,A.default)().use(function(e,t,r){return T(e,t,r)}).use(function(e,t,r){if(e.user)return _.User.findOne({where:{_id:e.user._id,deletedAt:null}}).then(function(n){return n?(e.user=n,r()):t.status(401).end()})}).use(function(e,t,r){var n=e.params.restauranteId;return isNaN(n)||(0^n)!=+n?t.status(400).end():(n=+n,e.user&&e.user.role&&e.user._id?"admin"===e.user.role?_.Restaurante.findOne({where:{_id:n}}).then(function(e){return e?r():t.status(401).end()}).catch(function(e){return r(e)}):_.MenuAdmin.findOne({where:{userId:e.user._id,restauranteId:n}}).then(function(e){return e?r():t.status(401).end()}).catch(function(e){return r(e)}):t.status(401).end())})}function o(){return function(e,t,r){var n=e.params.restauranteId;return e.user?isNaN(n)||(0^n)!=+n?t.status(400).end():(n=+n,_.Restaurante.findOne({where:{_id:n}}).then(function(a){return a?"admin"===e.user.role?(e.user.menuAdmin=!0,r()):_.MenuAdmin.find({where:{userId:e.user._id,restauranteId:n}}).then(function(t){return t?(e.user.menuAdmin=!0,r()):(e.user.menuAdmin=!1,r())}).catch(function(e){return r(e)}):t.status(404).end()})):r()}}function s(){return function(e,t,r){var n=e.params.restaurante;return n=decodeURI(n).replace(/_/g," "),e.user?_.Restaurante.findOne({where:{name:n}}).then(function(n){return n?"admin"===e.user.role?(e.user.menuAdmin=!0,r()):_.MenuAdmin.find({where:{userId:e.user._id,restauranteId:n._id}}).then(function(t){return t?(e.user.menuAdmin=!0,r()):(e.user.menuAdmin=!1,r())}).catch(function(e){return r(e)}):t.status(404).end()}):r()}}function u(){return function(e,t,r){var n=e.params,a=n.restauranteId,i=n.categoriaId,o=n.platilloId,s=0,u=0;return isNaN(a)||(0^a)!=+a?t.status(400).end():i||o?i&&(isNaN(i)||(0^i)!=+i)?t.status(400).end():o&&(isNaN(o)||(0^o)!=+o)?t.status(400).end():(a=+a,o?(s=+o,u=2):(s=+i,u=1),_.Restaurante.findOne({where:{_id:a}}).then(function(e){return e?_.MenuPaths.findOne({where:{parent:a,descendant:s,depth:u}}):(t.status(404).end(),null)}).then(function(e){return e?r():t.status(401).end()}).catch(function(e){return r(e)})):t.status(400).end()}}function d(){return function(e,t,r){var n=e.params,a=n.categoriaId,i=n.platilloId,o=[];return(isNaN(a)||(0^a)!=+a)&&o.push({message:"El identificador de la categoria no es válido",type:"Validation error",path:"categoriaId",value:a,raw:{}}),(isNaN(i)||(0^i)!=+i)&&o.push({message:"El identificador del platillo no es válido",type:"Validation error",path:"platilloId",value:i,raw:{}}),i=+i,a=+a,o.length>0?t.status(400).send(o):_.Categoria.findOne({where:{_id:a}}).then(function(e){return e?_.MenuPaths.findOne({where:{parent:a,descendant:i,depth:1}}):(t.status(404).end(),null)}).then(function(e){return e?r():t.status(401).end()}).catch(function(e){return r(e)})}}function l(){return function(e,t,r){var n=e.params,a=n.restauranteId,i=n.destinoId,o=[];return(isNaN(a)||(0^a)!=+a)&&o.push({message:"El identificador del restaurante no es válido",type:"Validation error",path:"restauranteId",value:a,raw:{}}),(isNaN(i)||(0^i)!=+i)&&o.push({message:"El identificador de la categoria destino no es válido",type:"Validation error",path:"destinoId",value:i,raw:{}}),i=+i,a=+a,o.length>0?t.status(400).send(o):_.Restaurante.findOne({where:{_id:a}}).then(function(e){return e?_.MenuPaths.findOne({where:{parent:a,descendant:i,depth:1}}):(t.status(404).end(),null)}).then(function(e){return e?r():t.status(401).end()}).catch(function(e){return r(e)})}}function c(){return(0,A.default)().use(function(e,t,r){T(e,t,r)}).use(function(e,t,r){return _.User.findOne({where:{_id:e.user._id,deletedAt:null}}).then(function(n){return n?(e.user=n,r()):t.status(401).end()}).catch(function(e){return r(e)})})}function h(e){if(!e)throw new Error("Required role needs to be set");return(0,A.default)().use(c()).use(function(t,r,n){var a=E.default.roles.indexOf(t.user.role),i=E.default.roles.indexOf(e);return-1!==a&&-1!==i&&a>=i?n():r.status(403).send("Forbidden")})}function p(e,t){return N.default.sign({_id:e,role:t},E.default.secrets.session,{expiresIn:2592e3})}function f(e,t){if(!e.user)return t.status(404).send("No se ha iniciado sesión, favor de intentarlo nuevamente.");var r=p(e.user._id,e.user.role);t.cookie("token",r),t.redirect("/")}Object.defineProperty(t,"__esModule",{value:!0}),t.getUserInfo=a,t.isMenuAdmin=i,t.getUserMenuAdminStatus=o,t.getUserRestuarantAdminStatus=s,t.nodeBelongsToRestaurant=u,t.nodeBelongsToCategory=d,t.destinationBelongsToRestaurant=l,t.isAuthenticated=c,t.hasRole=h,t.signToken=p,t.setTokenCookie=f;var m=r(0),E=n(m),y=r(58),N=n(y),I=r(55),g=n(I),v=r(49),A=n(v),_=r(1),T=(0,g.default)({secret:E.default.secrets.session})},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("path")},function(e,t,r){"use strict";e.exports={roles:["guest","usuario","admin"],extensiones:["jpeg","jpg","png"],cloudifyCloudName:"ddx0osgaz",maxFileSize:process.env.UPLOAD_MAX_FILE_SIZE||524288,fileQuantity:process.env.UPLOAD_FILE_QUANTITY||1}},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return new Promise(function(t,r){u.sendMail(e,function(e,n){e&&r(e),t(n)})})};var a=r(61),i=n(a),o=r(0),s=n(o),u=i.default.createTransport({host:"smtp.gmail.com",port:587,secure:!1,auth:s.default.smtp.credentials})},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("passport")},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(){f.listen(l.default.port)}var i=r(2),o=n(i),s=r(1),u=n(s),d=r(0),l=n(d),c=r(57),h=n(c),p=(0,o.default)(),f=h.default.createServer(p);"production"===(process.env.NODE_ENV||"development")&&(p.get("*.js",function(e,t,r){e.url=e.url+".gz",t.set("Content-Encoding","gzip"),t.set("Content-Type","text/javascript"),r()}),p.get("*.css",function(e,t,r){e.url=e.url+".gz",t.set("Content-Encoding","gzip"),t.set("Content-Type","text/css"),r()})),r(43).default(p),r(45).default(p),u.default.sequelize.sync().then(a).catch(function(e){console.log("Server failed to start due to error: "+e)}),e.exports=p},function(e,t){e.exports=require("babel-register")},function(e,t,r){"use strict";function n(e,t){return o.sequelize.query(l,{type:o.Sequelize.QueryTypes.SELECT}).then((0,s.respondWithResult)(t)).catch((0,s.handleError)(t))}function a(e,t){Reflect.deleteProperty(e.body,"createdAt"),Reflect.deleteProperty(e.body,"deletedAt"),e.body.authorId=e.user._id,o.Ciudad.build(e.body).save().then(function(e){return t.status(201).send(e)}).catch((0,s.validationError)(t))}function i(e,t){var r=[],n=e.params.id;if((isNaN(n)||(0^n)!=+n)&&r.push({message:"El id no es válido",type:"Validation error",path:"id",value:n,raw:{}}),r.length>0)return t.status(500).send(r);var a=new Date;return o.Ciudad.find({where:{_id:n,deletedAt:null}}).then((0,s.handleEntityNotFound)(t)).then(function(e){if(e){var t=d.default.cloneDeep(e);return e.update({deletedAt:a}).then(function(){return t})}return null}).then((0,s.respondWithResult)(t)).catch((0,s.handleError)(t))}Object.defineProperty(t,"__esModule",{value:!0}),t.index=n,t.create=a,t.destroy=i;var o=r(1),s=r(3),u=r(6),d=function(e){return e&&e.__esModule?e:{default:e}}(u),l="SELECT\n  t1._id, t1.name AS city, t1.`postal-code`,\n  t1.stateId, t2.name AS state\nFROM `"+o.Ciudad.tableName+"` t1\nLEFT JOIN `"+o.Estado.tableName+"` t2 ON t2._id = t1.stateId\nWHERE t1.deletedAt IS NULL AND t2.deletedAt IS NULL\nORDER BY t1.name;"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Ciudades",{_id:{type:t.INTEGER.UNSIGNED,allowNull:!1,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<o)throw new Error("Deben de ser cuando menos "+o+" caracteres")},maxlength:function(e){if(e&&e.length>s)throw new Error("Deben de ser máximo "+s+" caraceres")},checkUnique:function(t,r){var n=this;if(t){var o=n._id||-1,s="SELECT _id\n              FROM `"+i+"`\n              WHERE\n                LOWER(name)=LOWER(:name) AND\n                `postal-code`=:postalCode AND\n                deletedAt IS NULL\n              LIMIT 1;";return e.query(s,{replacements:{name:this.name,postalCode:this["postal-code"]},type:a.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]&&e[0]._id&&e[0]._id!==o?r("Esta ciudad ya está registada con este código postal"):r()}).catch(function(e){return r(e)})}return r()}}},"postal-code":{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"¿Cuál es el código postal de la ciudad?"},is:{args:/^[0-9]{5}$/,msg:"El código postal no es válido"}}},stateId:{type:t.INTEGER.UNSIGNED,allowNull:!1,validate:{checkState:function(t,r){if(!t)return r("El estado es requerido");if(-1===t||"-1"===t)return r("Es necesario seleccionar un estado");e.query("SELECT _id\n              FROM `estados`\n              WHERE _id = :id AND deletedAt IS NULL\n              LIMIT 1;",{replacements:{id:t},type:a.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]?r():r("Este estado aún no está dado de alta")})}}},authorId:{type:t.BIGINT.UNSIGNED,allowNull:!1},active:{type:t.BOOLEAN,defaultValue:!1},createdAt:{type:t.DATE,defaultValue:t.NOW},deletedAt:t.DATE},{hooks:{beforeValidate:function(e,t){e.stateId=e.stateId||-1},beforeCreate:function(e,t){e.stateId=e.stateId||-1},beforeUpdate:function(e,t){e.stateId=e.stateId||-1}},freezeTableName:!0,tableName:i})};var n=r(4),a=function(e){return e&&e.__esModule?e:{default:e}}(n),i="ciudades",o=0,s=255},function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var a=r(2),i=r(14),o=n(i),s=r(5),u=n(s),d=new a.Router;d.get("/",o.index),d.post("/",u.hasRole("admin"),o.create),d.delete("/:id",u.hasRole("admin"),o.destroy),e.exports=d},function(e,t,r){"use strict";function n(e,t){o.sequelize.query(u,{type:o.Sequelize.QueryTypes.SELECT}).then((0,s.respondWithResult)(t)).catch((0,s.handleError)(t))}function a(e,t){Reflect.deleteProperty(e.body,"createdAt"),Reflect.deleteProperty(e.body,"deletedAt"),e.body.authorId=e.user._id,o.Estado.build(e.body).save().then(function(e){return t.status(201).send(e)}).catch((0,s.validationError)(t))}function i(e,t){var r=[],n=e.params.id;return(isNaN(n)||(0^n)!=+n)&&r.push({message:"El id no es válido",type:"Validation error",path:"id",value:n,raw:{}}),r.length>0?t.status(500).send(r):o.Estado.find({where:{_id:n,deletedAt:null}}).then((0,s.handleEntityNotFound)(t)).then(function(e){return e?o.sequelize.query(d,{replacements:{id:n},type:o.Sequelize.QueryTypes.UPDATE}).then(function(){return e}):null}).then((0,s.respondWithResult)(t)).catch((0,s.handleError)(t))}Object.defineProperty(t,"__esModule",{value:!0}),t.index=n,t.create=a,t.destroy=i;var o=r(1),s=r(3),u="SELECT\n  _id, name AS state\nFROM `"+o.Estado.tableName+"`\nWHERE deletedAt IS NULL\nORDER BY name;",d="UPDATE `"+o.Estado.tableName+"`\nSET deletedAt = NOW()\nWHERE _id = :id AND deletedAt IS NULL;\nUPDATE `"+o.Ciudad.tableName+"`\nSET deletedAt = NOW()\nWHERE stateId = :id AND deletedAt IS NULL"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Estados",{_id:{type:t.INTEGER.UNSIGNED,allowNull:!1,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<o)throw new Error("Deben de ser cuando menos "+o+" caracteres")},maxlength:function(e){if(e&&e.length>s)throw new Error("Deben de ser máximo "+s+" caraceres")},checkUnique:function(t,r){var n=this;if(t){var o=n._id||-1,s="SELECT _id\n              FROM `"+i+"`\n              WHERE\n                LOWER(name)=LOWER(:name) AND\n                deletedAt IS NULL\n              LIMIT 1;";return e.query(s,{replacements:{name:t},type:a.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]&&e[0]._id&&e[0]._id!==o?r("Este estado ya está registrado"):r()}).catch(function(e){return r(e)})}return r()}}},authorId:{type:t.BIGINT.UNSIGNED,allowNull:!1},createdAt:{type:t.DATE,defaultValue:t.NOW},deletedAt:t.DATE},{freezeTableName:!0,tableName:i})};var n=r(4),a=function(e){return e&&e.__esModule?e:{default:e}}(n),i="estados",o=0,s=255},function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var a=r(2),i=r(17),o=n(i),s=r(5),u=n(s),d=new a.Router;d.get("/",o.index),d.post("/",u.hasRole("admin"),o.create),d.delete("/:id",u.hasRole("admin"),o.destroy),e.exports=d},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Categoria",{_id:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},name:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<a)throw new Error("Deben de ser cuando menos "+a+" caracteres")},maxlength:function(e){if(e&&e.length>i)throw new Error("Deben de ser máximo "+i+" caracteres")}}},position:{type:t.INTEGER.UNSIGNED,defaultValue:0}},{freezeTableName:!0,tableName:n})};var n="categorias",a=0,i=255},function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function a(e){return e&&e.__esModule?e:{default:e}}var i=r(2),o=r(60),s=a(o),u=r(23),d=n(u),l=r(0),c=a(l),h=r(5),p=n(h),f=r(3),m=new i.Router,E=s.default.memoryStorage(),y=(0,s.default)({storage:E,limits:{fileSize:c.default.maxFileSize,files:c.default.fileQuantity}}).single("image");m.get("/likes",p.isAuthenticated(),d.getLikes),m.get("/:restauranteId/likes",p.isAuthenticated(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.getLike),m.post("/:restauranteId/likes",p.isAuthenticated(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.likeRestaurant),m.delete("/:restauranteId/likes",p.isAuthenticated(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.unlikeRestaurant),m.get("/admin",p.hasRole("admin"),d.readAdmins),m.get("/:restauranteId/me/admin",(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),p.getUserInfo(),p.getUserMenuAdminStatus(),d.isAdmin),m.post("/:restauranteId/:userId/admin",p.hasRole("admin"),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("userId"),(0,f.checkIfErrors)(),d.createAdmin),m.delete("/:restauranteId/:userId/admin",p.hasRole("admin"),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("userId"),(0,f.checkIfErrors)(),d.deleteAdmin),m.post("/:restauranteId/categoria",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.createCategory),m.put("/:restauranteId/:categoriaId/categoria/editar",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),d.editCategory),m.put("/:restauranteId/:categoriaId/categoria/subir",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),d.increaseCategoryPosition),m.put("/:restauranteId/:categoriaId/categoria/bajar",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),d.decreaseCategoryPosition),m.delete("/:restauranteId/:categoriaId/categoria",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),d.destroyCategory),m.post("/:restauranteId/:categoriaId/platillo",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),y,d.createDish),m.put("/:restauranteId/:categoriaId/:platilloId/platillo/editar",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIdFromParams)("platilloId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),y,d.editDish),m.put("/:restauranteId/:categoriaId/:platilloId/platillo/subir",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIdFromParams)("platilloId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),p.nodeBelongsToCategory(),d.increaseDishPosition),m.put("/:restauranteId/:categoriaId/:platilloId/platillo/bajar",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIdFromParams)("platilloId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),p.nodeBelongsToCategory(),d.decreaseDishPosition),m.delete("/:restauranteId/:categoriaId/:platilloId/platillo",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIdFromParams)("categoriaId"),(0,f.checkIdFromParams)("platilloId"),(0,f.checkIfErrors)(),p.nodeBelongsToRestaurant(),p.nodeBelongsToCategory(),d.destroyDish),m.get("/:restaurante",p.getUserInfo(),p.getUserRestuarantAdminStatus(),d.breadcrumbs),m.put("/:restauranteId/admin/activate",p.hasRole("admin"),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.activateRestaurant),m.put("/:restauranteId/admin/deactivate",p.hasRole("admin"),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.deactivateRestaurant),m.get("/:limit/highlight",(0,f.checkIdFromParams)("limit"),(0,f.checkIfErrors)(),p.getUserInfo(),d.highlight),m.get("/:term/search",p.getUserInfo(),d.search),m.get("/",p.getUserInfo(),d.index),m.post("/",p.hasRole("admin"),y,d.createRestaurant),m.put("/:restauranteId",p.isMenuAdmin(),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),y,d.editRestaurant),m.delete("/:restauranteId",p.hasRole("admin"),(0,f.checkIdFromParams)("restauranteId"),(0,f.checkIfErrors)(),d.destroyRestaurant),e.exports=m},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("MenuAdmin",{userId:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},restauranteId:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0}},{validate:{checkUnique:function(){var t="SELECT COUNT(*) AS count\n        FROM `"+i+"`\n        WHERE userId = :userId AND restauranteId = :restauranteId;",r=this.userId,n=this.restauranteId;return e.query(t,{replacements:{userId:r,restauranteId:n},type:a.default.QueryTypes.SELECT}).then(function(e){if(0!==e[0].count){throw new Error("Este usuario ya administra el restaurante seleccionado")}}).catch(function(e){throw e})}},freezeTableName:!0,tableName:i})};var n=r(4),a=function(e){return e&&e.__esModule?e:{default:e}}(n),i="menu-admin"},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){var r=null,n={errors:[]},a=x.MenuNodes.build({active:e.body.active,tipo:F.default.tiposNodos[0],authorId:e.user._id}),i=x.Restaurante.build({name:e.body.name,description:e.body.description,cityId:e.body.cityId,keywords:e.body.keywords,telephone1:e.body.telephone1,telephone2:e.body.telephone2,address1:e.body.address1,address2:e.body.address2,horarioLunesApertura:e.body.horarioLunesApertura,horarioLunesCierre:e.body.horarioLunesCierre,horarioMartesApertura:e.body.horarioMartesApertura,horarioMartesCierre:e.body.horarioMartesCierre,horarioMiercolesApertura:e.body.horarioMiercolesApertura,horarioMiercolesCierre:e.body.horarioMiercolesCierre,horarioJuevesApertura:e.body.horarioJuevesApertura,horarioJuevesCierre:e.body.horarioJuevesCierre,horarioViernesApertura:e.body.horarioViernesApertura,horarioViernesCierre:e.body.horarioViernesCierre,horarioSabadoApertura:e.body.horarioSabadoApertura,horarioSabadoCierre:e.body.horarioSabadoCierre,horarioDomingoApertura:e.body.horarioDomingoApertura,horarioDomingoCierre:e.body.horarioDomingoCierre,postalCode:e.body.postalCode,servicioDomicilio:e.body.servicioDomicilio});return a.validate().catch(function(e){n.errors=n.errors.concat(e.errors)}).then(function(e){return i._id=0,i.validate()}).catch(function(e){n.errors=n.errors.concat(e.errors)}).then(function(){if(n.errors.length>0)throw n;if(e.file)return G.format(P.default.extname(e.file.originalname).toString(),e.file.buffer),(0,z.cloud)(G.content,{width:300,height:200,crop:"lfill"})}).then(function(e){return e&&e.public_id?(r=e.public_id,i.image=r):i.image="defaultRestaurant.jpg",x.sequelize.transaction(function(e){return a.save({transaction:e}).then(function(t){return i._id=a._id,x.sequelize.Promise.all([i.save({transaction:e}),x.MenuPaths.create({parent:a._id,descendant:a._id,depth:0},{transaction:e})])})})}).then(function(e){return t.status(201).send({_id:a._id,name:i.name,description:i.description,image:i.image,likes:i.likes,cityId:i.city,keywords:i.keywords,postalCode:i.postalCode,telephone1:i.telephone1,telephone2:i.telephone2,horarioLunesApertura:i.horarioLunesApertura,horarioLunesCierre:i.horarioLunesCierre,horarioMartesApertura:i.horarioMartesApertura,horarioMartesCierre:i.horarioMartesCierre,horarioMiercolesApertura:i.horarioMiercolesApertura,horarioMiercolesCierre:i.horarioMiercolesCierre,horarioJuevesApertura:i.horarioJuevesApertura,horarioJuevesCierre:i.horarioJuevesCierre,horarioViernesApertura:i.horarioViernesApertura,horarioViernesCierre:i.horarioViernesCierre,horarioSabadoApertura:i.horarioSabadoApertura,horarioSabadoCierre:i.horarioSabadoCierre,horarioDomingoApertura:i.horarioDomingoApertura,horarioDomingoCierre:i.horarioDomingoCierre,servicioDomicilio:i.servicioDomicilio})}).catch(function(e){if(r)return(0,z.cloudDelete)(r).then(function(){throw e});throw e}).catch((0,z.validationError)(t))}function i(e,t){var r=e.params.restauranteId;return x.sequelize.transaction(function(e){return x.MenuNodes.findOne({where:{_id:r,active:!1},lock:e.LOCK.UPDATE,transaction:e}).then(function(t){return t?(t.active=!0,t.save({transaction:e})):null})}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function o(e,t){var r=e.params.restauranteId;return x.sequelize.transaction(function(e){return x.MenuNodes.findOne({where:{_id:r,active:!0},lock:e.LOCK.UPDATE,transaction:e}).then(function(t){return t?(t.active=!1,t.save({transaction:e})):null})}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function s(e,t){e.user&&"admin"===e.user.role||Reflect.deleteProperty(e.body,"name");var r=e.body,n=e.params.restauranteId,a=void 0,i=void 0,o=void 0,s={errors:[]},u=function(u){return x.sequelize.transaction(function(t){return x.Restaurante.findOne({where:{_id:n},lock:t.LOCK.UPDATE,transaction:t}).then(function(e){return e?(a=e,x.MenuNodes.findOne({where:{_id:n,deletedAt:null},lock:t.LOCK.UPDATE,transaction:t})):null}).then(function(t){return t?(i=t,i.active=void 0===r.active||null===r.active?i.active:r.active,i.updatedAt=new Date,i.editorId=e.user._id,i.validate()):null}).catch(function(e){return s.errors=s.errors.concat(e.errors),{}}).then(function(e){return e?(a.name=r.name||a.name,a.description=r.description||a.description,a.cityId=r.cityId||a.cityId,a.telephone1=r.telephone1||a.telephone1,a.telephone2=r.telephone2||a.telephone2,a.address1=r.address1||a.address1,a.address2=r.address2||a.address2,a.postalCode=r.postalCode||a.postalCode,a.keywords=r.keywords||a.keywords,a.horarioLunesApertura=r.horarioLunesApertura||a.horarioLunesApertura,a.horarioLunesCierre=r.horarioLunesCierre||a.horarioLunesCierre,a.horarioMartesApertura=r.horarioMartesApertura||a.horarioMartesApertura,a.horarioMartesCierre=r.horarioMartesCierre||a.horarioMartesCierre,a.horarioMiercolesApertura=r.horarioMiercolesApertura||a.horarioMiercolesApertura,a.horarioMiercolesCierre=r.horarioMiercolesCierre||a.horarioMiercolesCierre,a.horarioJuevesApertura=r.horarioJuevesApertura||a.horarioJuevesApertura,a.horarioJuevesCierre=r.horarioJuevesCierre||a.horarioJuevesCierre,a.horarioViernesApertura=r.horarioViernesApertura||a.horarioViernesApertura,a.horarioViernesCierre=r.horarioViernesCierre||a.horarioViernesCierre,a.horarioSabadoApertura=r.horarioSabadoApertura||a.horarioSabadoApertura,a.horarioSabadoCierre=r.horarioSabadoCierre||a.horarioSabadoCierre,a.horarioDomingoApertura=r.horarioDomingoApertura||a.horarioDomingoApertura,a.horarioDomingoCierre=r.horarioDomingoCierre||a.horarioDomingoCierre,a.servicioDomicilio=void 0===r.servicioDomicilio||null===r.servicioDomicilio?a.servicioDomicilio:r.servicioDomicilio,a.validate()):null}).catch(function(e){return s.errors=s.errors.concat(e.errors),{}}).then(function(e){if(e){if(s.errors.length>0)throw s;return u&&(o=a.image,a.image=u),i.save({transaction:t})}return null}).then(function(e){return e?a.save({transaction:t}):null})}).then(function(e){return e?!u||"defaultRestaurant.jpg"===o||(0,z.cloudDelete)(o).then(function(){return!0}).catch(function(){return!0}):null}).then(function(e){return e?{_id:i._id,name:a.name,description:a.description,cityId:a.cityId,keywords:a.keywords,image:a.image,likes:a.likes,postalCode:a.postalCode,telephone1:a.telephone1,telephone2:a.telephone2,horarioLunesApertura:a.horarioLunesApertura,horarioLunesCierre:a.horarioLunesCierre,horarioMartesApertura:a.horarioMartesApertura,horarioMartesCierre:a.horarioMartesCierre,horarioMiercolesApertura:a.horarioMiercolesApertura,horarioMiercolesCierre:a.horarioMiercolesCierre,horarioJuevesApertura:a.horarioJuevesApertura,horarioJuevesCierre:a.horarioJuevesCierre,horarioViernesApertura:a.horarioViernesApertura,horarioViernesCierre:a.horarioViernesCierre,horarioSabadoApertura:a.horarioSabadoApertura,horarioSabadoCierre:a.horarioSabadoCierre,horarioDomingoApertura:a.horarioDomingoApertura,horarioDomingoCierre:a.horarioDomingoCierre,servicioDomicilio:a.servicioDomicilio}:null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch(function(e){if(u)return(0,z.cloudDelete)(u).then(function(){throw e});throw e}).catch((0,z.validationError)(t))};return e.file?(G.format(P.default.extname(e.file.originalname).toString(),e.file.buffer),(0,z.cloud)(G.content,{width:300,height:200,crop:"lfill"}).then(function(e){return u(e&&e.public_id?e.public_id:null)})):u(null)}function u(e,t){var r=e.params.restauranteId,n=void 0,a=void 0,i=new Date;return x.sequelize.transaction(function(t){return x.Restaurante.findOne({where:{_id:r},lock:t.LOCK.UPDATE,transaction:t}).then(function(e){return e?(n=e,x.MenuNodes.findOne({where:{_id:e._id,deletedAt:null},lock:t.LOCK.UPDATE,transaction:t})):null}).then(function(r){return r?(a=r,r.update({editorId:e.user._id,deletedAt:i},{transaction:t})):null})}).then(function(e){return e?"defaultRestaurant.jpg"===n.image||(0,z.cloudDelete)(n.image).then(function(){return!0}).catch(function(){return!0}):null}).then(function(e){return e?{_id:a._id,name:a.name,description:n.description,cityId:n.cityId,image:n.image,likes:n.likes,postalCode:n.postalCode,telephone1:n.telephone1,telephone2:n.telephone2,horarioLunesApertura:n.horarioLunesApertura,horarioLunesCierre:n.horarioLunesCierre,horarioMartesApertura:n.horarioMartesApertura,horarioMartesCierre:n.horarioMartesCierre,horarioMiercolesApertura:n.horarioMiercolesApertura,horarioMiercolesCierre:n.horarioMiercolesCierre,horarioJuevesApertura:n.horarioJuevesApertura,horarioJuevesCierre:n.horarioJuevesCierre,horarioViernesApertura:n.horarioViernesApertura,horarioViernesCierre:n.horarioViernesCierre,horarioSabadoApertura:n.horarioSabadoApertura,horarioSabadoCierre:n.horarioSabadoCierre,horarioDomingoApertura:n.horarioDomingoApertura,horarioDomingoCierre:n.horarioDomingoCierre,servicioDomicilio:n.servicioDomicilio}:null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function d(e,t){var r=e.user&&"admin"===e.user.role?V.indexQueryAdmin:V.indexQuery;return x.sequelize.query(r,{type:x.Sequelize.QueryTypes.SELECT}).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function l(e,t){var r=decodeURI(e.params.term),n=e.user&&"admin"===e.user.role?V.searchQueryAdmin:V.searchQuery;return x.sequelize.query(n,{replacements:{term:r},type:x.Sequelize.QueryTypes.SELECT}).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function c(e,t){var r=e.params.limit,n=e.user&&"admin"===e.user.role?V.highlightQueryAdmin:V.highlightQuery;return x.sequelize.query(n,{replacements:{limit:r},type:x.Sequelize.QueryTypes.SELECT}).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function h(e,t){return x.sequelize.query(V.readAdminQuery,{type:x.Sequelize.QueryTypes.SELECT}).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function p(e,t){var r=e.params,n=r.restauranteId,a=r.userId;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:n},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.User.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}):null}).then(function(t){return t?x.MenuAdmin.create({restauranteId:n,userId:a},{transaction:e}):null})}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t,201)).catch((0,z.validationError)(t))}function f(e,t){var r=e.params,n=r.restauranteId,a=r.userId,i=void 0;return x.sequelize.transaction(function(e){return x.MenuAdmin.find({where:{restauranteId:n,userId:a},lock:e.LOCK.UPDATE,transaction:e}).then(function(t){return t?(i=k.default.cloneDeep(t),t.destroy({transaction:e})):null})}).then(function(e){return e?i:null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function m(e,t){var r=e.params.restauranteId;return e.user&&e.user.menuAdmin?t.status(200).send({_id:r,admin:!0}):t.status(200).send({_id:r,admin:!1})}function E(e,t){var r=void 0,n=e.params.restaurante,a=void 0;return n=decodeURI(n).replace(/_/g," "),r=e.user&&e.user.menuAdmin?V.getDescendantsBreadcrumbsQueryAdmin:V.getDescendantsBreadcrumbsQuery,x.Restaurante.findOne({where:{name:n}}).then(function(t){return t?e.user&&e.user.menuAdmin?x.MenuNodes.findOne({where:{_id:t._id}}):x.MenuNodes.findOne({where:{_id:t._id,active:!0}}):null}).then((0,z.handleEntityNotFound)(t)).then(function(t){return t?(a=t._id,e.user&&e.user.menuAdmin?t:x.sequelize.transaction(function(t){var r=e.headers["x-forwarded-for"]||e.connection.remoteAddress;return x.sequelize.Promise.all([x.Visita.create({ip:r,restauranteId:a},{transaction:t}),x.Restaurante.update({visitas:x.sequelize.literal("visitas + 1")},{where:{_id:a},transaction:t})])})):null}).then(function(e){return e?x.sequelize.query(r,{type:x.Sequelize.QueryTypes.SELECT,replacements:{nodeId:a}}):null}).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function y(e,t){var r=e.body,n=r.name,a=r.active,i=e.params.restauranteId,o={};return x.sequelize.transaction(function(t){return x.Restaurante.findOne({where:{_id:i},attributes:["_id"],lock:t.LOCK.SHARE,transaction:t}).then(function(r){return r?x.MenuNodes.create({active:a,tipo:F.default.tiposNodos[1],authorId:e.user._id},{transaction:t}):null}).then(function(e){return e?(o._id=e._id,o.name=n,o.active=e.active,x.sequelize.query(V.nodeCountQuery,{type:x.Sequelize.QueryTypes.SELECT,replacements:{parentNodeId:i,depth:1},transaction:t}).then(function(r){return o.position=r[0].count+1,x.Categoria.create({name:n,_id:e._id,position:r[0].count+1},{transaction:t})}).then(function(r){return x.sequelize.query(V.addLeafQuery,{type:x.Sequelize.QueryTypes.INSERT,replacements:{newNodeId:e._id,parentId:i},transaction:t})})):null})}).then((0,z.handleEntityNotFound)(t)).then(function(e){return e?t.status(201).send(o):null}).catch((0,z.validationError)(t))}function N(e,t){var r=e.body,n=r.name,a=r.active,i=e.params,o=i.categoriaId,s=i.restauranteId,u=void 0,d=void 0,l={errors:[]};return x.sequelize.transaction(function(t){return x.Restaurante.findOne({where:{_id:s},attributes:["_id"],lock:t.LOCK.SHARE,transaction:t}).then(function(e){return e?x.Categoria.findOne({where:{_id:o},lock:t.LOCK.UPDATE,transaction:t}):null}).then(function(e){return e?(u=e,x.MenuNodes.findOne({where:{_id:o},lock:t.LOCK.UPDATE,transaction:t})):null}).then(function(t){return t?(d=t,d.editorId=e.user._id,d.active=void 0===a||null===a?d.active:a,u.name=n||u.name,d.validate()):null}).catch(function(e){return l.errors=l.errors.concat(e.errors),{}}).then(function(e){return e?u.validate():null}).catch(function(e){return l.errors=l.errors.concat(e.errors),{}}).then(function(e){if(e){if(l.errors.length>0)throw l;return d.save({transaction:t})}return null}).then(function(e){return e?u.save({transaction:t}):null})}).then(function(e){if(e)return{_id:s,child:{_id:d._id,name:u.name,active:d.active}}}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}function I(e,t){var r=e.params,n=r.categoriaId,a=r.restauranteId;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:n},lock:e.LOCK.UPDATE,transaction:e}):null}).then(function(r){return r?x.sequelize.query(V.nodeCountQuery,{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a},transaction:e}).then(function(n){return n[0].count===r.position?(t.status(204).end(),null):x.sequelize.query((0,V.increasePositionNodeQuery)(x.Categoria.tableName),{type:x.Sequelize.QueryTypes.UPDATE,replacements:{depth:1,parentNodeId:a,nodePosition:r.position,nodeId:r._id},transaction:e})}):null})}).then(function(e){if(e)return x.sequelize.query((0,V.getNodesPositionQuery)(x.Categoria.tableName),{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a}})}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}function g(e,t){var r=e.params,n=r.categoriaId,a=r.restauranteId;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:n},lock:e.LOCK.UPDATE,transaction:e}):null}).then(function(r){return r?x.sequelize.query(V.nodeCountQuery,{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a},transaction:e}).then(function(n){return 1===r.position?(t.status(204).end(),null):x.sequelize.query((0,V.decreasePositionNodeQuery)(x.Categoria.tableName),{type:x.Sequelize.QueryTypes.UPDATE,replacements:{depth:1,parentNodeId:a,nodePosition:r.position,nodeId:r._id},transaction:e})}):null})}).then(function(e){if(e)return x.sequelize.query((0,V.getNodesPositionQuery)(x.Categoria.tableName),{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a}})}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}function v(e,t){var r=e.params,n=r.categoriaId,a=r.restauranteId,i=void 0;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:n},lock:e.LOCK.UPDATE,transaction:e}):null}).then(function(t){return t?(i=k.default.cloneDeep(t),x.sequelize.query(V.deleteLeafAndDescendantsQuery,{type:x.Sequelize.QueryTypes.DELETE,replacements:{deletedNodeId:i._id},transaction:e}).then(function(){return x.sequelize.query((0,V.updatePositionDeleteNodeQuery)(x.Categoria.tableName),{type:x.Sequelize.QueryTypes.UPDATE,replacements:{depth:1,parentNodeId:a,deletedNodePosition:i.position},transaction:e})})):null})}).then(function(e){return e?i:null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function A(e,t){var r=e.params,n=r.restauranteId,a=r.categoriaId,i=void 0,o={errors:[]},s=x.MenuNodes.build({active:e.body.active,tipo:F.default.tiposNodos[2],authorId:e.user._id}),u=x.Platillo.build({name:e.body.name,description:e.body.description,price:e.body.price});return s.validate().catch(function(e){o.errors=o.errors.concat(e.errors)}).then(function(e){return u._id=0,u.validate()}).catch(function(e){o.errors=o.errors.concat(e.errors)}).then(function(){if(o.errors.length>0)throw o;return e.file?(G.format(P.default.extname(e.file.originalname).toString(),e.file.buffer),(0,z.cloud)(G.content,{width:500,height:500})):null}).then(function(e){return e&&e.public_id?(i=e.public_id,u.image=i):u.image=null,x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:n},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}):null}).then(function(t){return t?s.save({transaction:e}):null}).then(function(t){return t?x.sequelize.query(V.nodeCountQuery,{type:x.Sequelize.QueryTypes.SELECT,replacements:{parentNodeId:a,depth:1},transaction:e}):null}).then(function(t){return t?(u._id=s._id,u.position=t[0].count+1,u.save({transaction:e})):null}).then(function(t){return t?x.sequelize.query(V.addLeafQuery,{type:x.Sequelize.QueryTypes.INSERT,replacements:{newNodeId:s._id,parentId:a},transaction:e}):null})})}).then((0,z.handleEntityNotFound)(t)).then(function(e){return e?t.status(201).send({_id:s._id,name:u.name,active:s.active,description:u.description,price:u.price,position:u.position,image:u.image}):null}).catch(function(e){if(i)return(0,z.cloudDelete)(i).then(function(){throw e});throw e}).catch((0,z.validationError)(t))}function _(e,t){var r=e.body,n=r.name,a=r.active,i=r.description,o=r.price,s=e.params,u=s.restauranteId,d=s.categoriaId,l=s.platilloId,c=void 0,h=void 0,p=void 0,f={errors:[]},m=function(r){return x.sequelize.transaction(function(t){return x.Restaurante.findOne({where:{_id:u},attributes:["_id"],lock:t.LOCK.SHARE,transaction:t}).then(function(e){return e?x.Categoria.findOne({where:{_id:d},attributes:["_id"],lock:t.LOCK.SHARE,transaction:t}):null}).then(function(e){return e?x.Platillo.findOne({where:{_id:l},lock:t.LOCK.UPDATE,transaction:t}):null}).then(function(s){return s?(h=s,s.description=i||s.description,s.name=n||s.name,s.price=o||s.price,x.MenuNodes.findOne({where:{_id:l},lock:t.LOCK.UPDATE,transaction:t}).then(function(t){return c=t,c.editorId=e.user._id,c.active=void 0===a||null===a?c.active:a,c.updatedAt=new Date,c.validate()}).catch(function(e){f.errors=f.errors.concat(e.errors)}).then(function(){return s.validate()}).catch(function(e){f.errors=f.errors.concat(e.errors)}).then(function(){if(f.errors.length>0)throw f;return r&&(p=s.image,s.image=r),c.save({transaction:t})}).then(function(){return s.save({transaction:t})})):null})}).then(function(e){return e?!r||""===p||(0,z.cloudDelete)(p).then(function(){return!0}).catch(function(){return!0}):null}).then(function(e){return e?{_id:u,child:{_id:c._id,name:c.name,active:c.active,description:h.description,price:h.price,imagenPlatillo:h.image}}:null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch(function(e){if(r)return(0,z.cloudDelete)(r).then(function(){throw e});throw e}).catch((0,z.validationError)(t))};return e.file?(G.format(P.default.extname(e.file.originalname).toString(),e.file.buffer),(0,z.cloud)(G.content,{width:500,height:500}).then(function(e){return m(e&&e.public_id?e.public_id:null)})):m(null)}function T(e,t){var r=e.params,n=r.platilloId,a=r.categoriaId,i=r.restauranteId;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:i},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}):null}).then(function(t){return t?x.Platillo.findOne({where:{_id:n},lock:e.LOCK.UPDATE,transaction:e}):null}).then(function(r){return r?x.sequelize.query(V.nodeCountQuery,{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a},transaction:e}).then(function(n){return n[0].count===r.position?(t.status(204).end(),null):x.sequelize.query((0,V.increasePositionNodeQuery)(x.Platillo.tableName),{type:x.Sequelize.QueryTypes.UPDATE,replacements:{depth:1,parentNodeId:a,nodePosition:r.position,nodeId:r._id},transaction:e})}):null})}).then(function(e){return e?x.sequelize.query((0,V.getNodesPositionQuery)(x.Platillo.tableName),{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a}}):null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}function S(e,t){var r=e.params,n=r.platilloId,a=r.categoriaId,i=r.restauranteId;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:i},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}):null}).then(function(t){return t?x.Platillo.findOne({where:{_id:n},lock:e.LOCK.UPDATE,transaction:e}):null}).then(function(r){return r?1===r.position?(t.status(204).end(),null):x.sequelize.query((0,V.decreasePositionNodeQuery)(x.Platillo.tableName),{type:x.Sequelize.QueryTypes.UPDATE,replacements:{depth:1,parentNodeId:a,nodePosition:r.position,nodeId:r._id},transaction:e}):null})}).then(function(e){return e?x.sequelize.query((0,V.getNodesPositionQuery)(x.Platillo.tableName),{type:x.Sequelize.QueryTypes.SELECT,replacements:{depth:1,parentNodeId:a}}):null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}function b(e,t){var r=e.params,n=r.platilloId,a=r.categoriaId,i=r.restauranteId,o=null,s=void 0;return x.sequelize.transaction(function(e){return x.Restaurante.findOne({where:{_id:i},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}).then(function(t){return t?x.Categoria.findOne({where:{_id:a},attributes:["_id"],lock:e.LOCK.SHARE,transaction:e}):null}).then(function(t){return t?x.Platillo.findOne({where:{_id:n},lock:e.LOCK.UPDATE,transaction:e}):null}).then(function(t){return t?(s=k.default.cloneDeep(t),o=t.image,x.sequelize.query(V.deleteLeafAndDescendantsQuery,{type:x.Sequelize.QueryTypes.DELETE,replacements:{deletedNodeId:t._id},transaction:e}).then(function(){return x.sequelize.query((0,V.updatePositionDeleteNodeQuery)(x.Platillo.tableName),{type:x.Sequelize.QueryTypes.UPDATE,replacements:{depth:1,parentNodeId:a,deletedNodePosition:t._id},transaction:e})})):null})}).then(function(e){return e?""!==o?(0,z.cloudDelete)(o).then(function(){return s}).catch(function(){return s}):s:null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function R(e,t){var r=e.user._id;return x.sequelize.query(V.indexLikeQuery,{replacements:{userId:r},type:x.Sequelize.QueryTypes.SELECT}).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function C(e,t){var r=e.params.restauranteId,n=e.user._id;x.Restaurante.findOne({where:{_id:r}}).then(function(e){return e?x.MenuLikes.findOne({where:{restauranteId:r,userId:n}}).then(function(e){return e?{restauranteId:r,userId:n,like:!0}:{restauranteId:r,userId:n,like:!1}}):null}).then((0,z.handleEntityNotFound)(t)).then((0,z.respondWithResult)(t)).catch((0,z.handleError)(t))}function O(e,t){var r=e.params.restauranteId,n=e.user._id;x.Restaurante.findOne({where:{_id:r}}).then(function(e){return e?x.MenuLikes.findOne({where:{restauranteId:r,userId:n}}).then(function(e){return e?(t.status(400).end(),null):x.sequelize.transaction(function(e){return x.sequelize.Promise.all([x.MenuLikes.create({restauranteId:r,userId:n},{transaction:e}),x.Restaurante.update({likes:x.sequelize.literal("likes + 1")},{where:{_id:r},transaction:e})])})}):(t.status(404).end(),null)}).then(function(e){return e?{restauranteId:r,userId:n}:null}).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}function D(e,t){var r=e.params.restauranteId,n=e.user._id;x.Restaurante.findOne({where:{_id:r}}).then(function(e){return e?x.MenuLikes.findOne({where:{restauranteId:r,userId:n}}).then(function(e){return e?x.sequelize.transaction(function(e){return x.sequelize.Promise.all([x.MenuLikes.destroy({where:{restauranteId:r,userId:n},transaction:e}),x.Restaurante.update({likes:x.sequelize.literal("likes - 1")},{where:{_id:r},transaction:e})])}):(t.status(400).end(),null)}):(t.status(404).end(),null)}).then(function(e){return e?{restauranteId:r,userId:n}:null}).then((0,z.respondWithResult)(t)).catch((0,z.validationError)(t))}Object.defineProperty(t,"__esModule",{value:!0}),t.createRestaurant=a,t.activateRestaurant=i,t.deactivateRestaurant=o,t.editRestaurant=s,t.destroyRestaurant=u,t.index=d,t.search=l,t.highlight=c,t.readAdmins=h,t.createAdmin=p,t.deleteAdmin=f,t.isAdmin=m,t.breadcrumbs=E,t.createCategory=y,t.editCategory=N,t.increaseCategoryPosition=I,t.decreaseCategoryPosition=g,t.destroyCategory=v,t.createDish=A,t.editDish=_,t.increaseDishPosition=T,t.decreaseDishPosition=S,t.destroyDish=b,t.getLikes=R,t.getLike=C,t.likeRestaurant=O,t.unlikeRestaurant=D;var M=r(53),L=n(M),w=r(7),P=n(w),q=r(6),k=n(q),U=r(0),F=n(U),x=r(1),z=r(3),V=r(27),G=new L.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("MenuLikes",{userId:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},restauranteId:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0}},{freezeTableName:!0,tableName:n})};var n="menu-likes"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("MenuNodes",{_id:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0,autoIncrement:!0},tipo:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<o)throw new Error("Deben de ser cuando menos "+o+" caracteres")},maxlength:function(e){if(e&&e.length>s)throw new Error("Deben de ser máximo "+s+" caraceres")},isIn:{args:[a.default.tiposNodos],msg:"Este tipo de nodo no es válido"}}},active:{type:t.BOOLEAN,defaultValue:!1},authorId:t.BIGINT.UNSIGNED,editorId:t.BIGINT.UNSIGNED,createdAt:{type:t.DATE,defaultValue:t.NOW()},updatedAt:{type:t.DATE},deletedAt:t.DATE},{freezeTableName:!0,tableName:i})};var n=r(0),a=function(e){return e&&e.__esModule?e:{default:e}}(n),i="menu-nodes",o=0,s=255},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("MenuPaths",{parent:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},descendant:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},depth:{type:t.INTEGER.UNSIGNED,allowNull:!1,defaultValue:0}},{freezeTableName:!0,tableName:n})};var n="menu-paths"},function(e,t,r){"use strict";function n(e){return"UPDATE `"+e+"` t1\n  INNER JOIN `"+s.MenuPaths.tableName+"` t2 ON t1._id = t2.descendant\n  SET t1.position = t1.position - 1\n  WHERE t2.parent = :parentNodeId\n    AND t2.depth = :depth\n    AND t1.position > :deletedNodePosition;"}function a(e){return"UPDATE `"+e+"` t1\n  INNER JOIN `"+s.MenuPaths.tableName+"` t2 ON t1._id = t2.descendant\n  SET t1.position = t1.position - 1\n  WHERE t2.parent = :parentNodeId\n  \tAND depth = :depth\n  \tAND position = :nodePosition + 1;\n  UPDATE `"+e+"` SET position = position + 1\n  WHERE _id = :nodeId;"}function i(e){return"UPDATE `"+e+"` t1\n  INNER JOIN `"+s.MenuPaths.tableName+"` t2 ON t1._id = t2.descendant\n  SET t1.position = t1.position + 1\n  WHERE t2.parent = :parentNodeId\n  \tAND depth = :depth\n  \tAND position = :nodePosition - 1;\n  UPDATE `"+e+"` SET position = position - 1\n  WHERE _id = :nodeId;"}function o(e){return"SELECT t1._id, t1.position\n  FROM `"+e+"` t1\n  INNER JOIN `"+s.MenuPaths.tableName+"` t2 ON t1._id = t2.descendant\n  WHERE t2.parent = :parentNodeId AND depth = :depth;"}Object.defineProperty(t,"__esModule",{value:!0}),t.getDescendantsBreadcrumbsQueryAdmin=t.getDescendantsBreadcrumbsQuery=t.nodeCountQuery=t.connectSubtreeQuery=t.disconnectSubtreeQuery=t.deleteLeafAndDescendantsQuery=t.addLeafQuery=t.highlightQueryAdmin=t.highlightQuery=t.searchQueryAdmin=t.indexQueryAdmin=t.indexLikeQuery=t.searchQuery=t.indexQuery=t.readAdminQuery=void 0,t.updatePositionDeleteNodeQuery=n,t.increasePositionNodeQuery=a,t.decreasePositionNodeQuery=i,t.getNodesPositionQuery=o;var s=r(1);t.readAdminQuery="SELECT t1.userId, t1.restauranteId, t2.email\n  FROM `"+s.MenuAdmin.tableName+"` t1\n  LEFT JOIN `"+s.User.tableName+"` t2 ON t1.userId = t2._id;",t.indexQuery="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT t1._id, t1.description, t1.image, t1.likes, t1.postalCode,\n      t1.telephone1, t1.telephone2, t1.visitas,\n      t1.address1, t1.address2,\n      t1.cityId, t1.keywords,\n      t1.horarioLunesApertura, t1.horarioLunesCierre,\n      t1.horarioMartesApertura, t1.horarioMartesCierre,\n      t1.horarioMiercolesApertura, t1.horarioMiercolesCierre,\n      t1.horarioJuevesApertura, t1.horarioJuevesCierre,\n      t1.horarioViernesApertura, t1.horarioViernesCierre,\n      t1.horarioSabadoApertura, t1.horarioSabadoCierre,\n      t1.horarioDomingoApertura, t1.horarioDomingoCierre,\n      t1.servicioDomicilio,\n      t1.name,\n      t3.name AS city, t3.stateId,\n      t4.name AS state\n    FROM `"+s.Restaurante.tableName+"` t1\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t2 ON t2._id = t1._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t3 ON t3._id = t1.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t4 ON t4._id = t3.stateId\n    WHERE t2.active = 1\n    ORDER BY t1.visitas ASC) x,\n(SELECT @row := 0) y;",t.searchQuery="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT t1._id, t1.description, t1.image, t1.likes, t1.postalCode,\n      t1.telephone1, t1.telephone2, t1.visitas,\n      t1.address1, t1.address2,\n      t1.cityId, t1.keywords,\n      t1.horarioLunesApertura, t1.horarioLunesCierre,\n      t1.horarioMartesApertura, t1.horarioMartesCierre,\n      t1.horarioMiercolesApertura, t1.horarioMiercolesCierre,\n      t1.horarioJuevesApertura, t1.horarioJuevesCierre,\n      t1.horarioViernesApertura, t1.horarioViernesCierre,\n      t1.horarioSabadoApertura, t1.horarioSabadoCierre,\n      t1.horarioDomingoApertura, t1.horarioDomingoCierre,\n      t1.servicioDomicilio,\n      t1.name,\n      t3.name AS city, t3.stateId,\n      t4.name AS state\n    FROM `"+s.Restaurante.tableName+"` t1\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t2 ON t2._id = t1._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t3 ON t3._id = t1.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t4 ON t4._id = t3.stateId\n    WHERE t2.active = 1 AND\n      MATCH(t1.name, t1.description, t1.keywords) AGAINST\n      (:term IN NATURAL LANGUAGE MODE)\n    ORDER BY t1.visitas ASC) x,\n(SELECT @row := 0) y;",t.indexLikeQuery="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT\n\t\tt2._id, t2.description, t2.image, t2.likes, t2.postalCode,\n      t2.telephone1, t2.telephone2, t2.visitas,\n      t2.address1, t2.address2,\n      t2.cityId, t2.keywords,\n      t2.horarioLunesApertura, t2.horarioLunesCierre,\n      t2.horarioMartesApertura, t2.horarioMartesCierre,\n      t2.horarioMiercolesApertura, t2.horarioMiercolesCierre,\n      t2.horarioJuevesApertura, t2.horarioJuevesCierre,\n      t2.horarioViernesApertura, t2.horarioViernesCierre,\n      t2.horarioSabadoApertura, t2.horarioSabadoCierre,\n      t2.horarioDomingoApertura, t2.horarioDomingoCierre,\n      t2.servicioDomicilio,\n      t2.name,\n      t4.name AS city, t4.stateId,\n      t5.name AS state\n    FROM `"+s.MenuLikes.tableName+"` t1\n    LEFT JOIN `"+s.Restaurante.tableName+"` t2 ON t2._id = t1.restauranteId\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t3 ON t3._id = t2._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t4 ON t4._id = t2.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t5 ON t5._id = t4.stateId\n    WHERE t3.active = 1 AND t1.userId = :userId\n    ORDER BY t2.name ASC) x,\n(SELECT @row := 0) y;",t.indexQueryAdmin="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT t1._id, t1.description, t1.image, t1.likes, t1.postalCode,\n      t1.telephone1, t1.telephone2, t1.visitas,\n      t1.address1, t1.address2,\n      t1.cityId, t1.keywords,\n      t1.horarioLunesApertura, t1.horarioLunesCierre,\n      t1.horarioMartesApertura, t1.horarioMartesCierre,\n      t1.horarioMiercolesApertura, t1.horarioMiercolesCierre,\n      t1.horarioJuevesApertura, t1.horarioJuevesCierre,\n      t1.horarioViernesApertura, t1.horarioViernesCierre,\n      t1.horarioSabadoApertura, t1.horarioSabadoCierre,\n      t1.horarioDomingoApertura, t1.horarioDomingoCierre,\n      t1.servicioDomicilio,\n      t1.name, t2.active,\n      t3.name AS city, t3.stateId,\n      t4.name AS state\n    FROM `"+s.Restaurante.tableName+"` t1\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t2 ON t2._id = t1._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t3 ON t3._id = t1.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t4 ON t4._id = t3.stateId\n    ORDER BY t1.name) x,\n(SELECT @row := 0) y;",t.searchQueryAdmin="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT t1._id, t1.description, t1.image, t1.likes, t1.postalCode,\n      t1.telephone1, t1.telephone2, t1.visitas,\n      t1.address1, t1.address2,\n      t1.cityId, t1.keywords,\n      t1.horarioLunesApertura, t1.horarioLunesCierre,\n      t1.horarioMartesApertura, t1.horarioMartesCierre,\n      t1.horarioMiercolesApertura, t1.horarioMiercolesCierre,\n      t1.horarioJuevesApertura, t1.horarioJuevesCierre,\n      t1.horarioViernesApertura, t1.horarioViernesCierre,\n      t1.horarioSabadoApertura, t1.horarioSabadoCierre,\n      t1.horarioDomingoApertura, t1.horarioDomingoCierre,\n      t1.servicioDomicilio,\n      t1.name, t2.active,\n      t3.name AS city, t3.stateId,\n      t4.name AS state\n    FROM `"+s.Restaurante.tableName+"` t1\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t2 ON t2._id = t1._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t3 ON t3._id = t1.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t4 ON t4._id = t3.stateId\n    WHERE MATCH(t1.name, t1.description, t1.keywords) AGAINST\n    (:term IN NATURAL LANGUAGE MODE)\n    ORDER BY t1.name) x,\n(SELECT @row := 0) y;",t.highlightQuery="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT t1._id, t1.description, t1.image, t1.likes, t1.postalCode,\n      t1.telephone1, t1.telephone2, t1.visitas,\n      t1.address1, t1.address2,\n      t1.cityId, t1.keywords,\n      t1.horarioLunesApertura, t1.horarioLunesCierre,\n      t1.horarioMartesApertura, t1.horarioMartesCierre,\n      t1.horarioMiercolesApertura, t1.horarioMiercolesCierre,\n      t1.horarioJuevesApertura, t1.horarioJuevesCierre,\n      t1.horarioViernesApertura, t1.horarioViernesCierre,\n      t1.horarioSabadoApertura, t1.horarioSabadoCierre,\n      t1.horarioDomingoApertura, t1.horarioDomingoCierre,\n      t1.servicioDomicilio,\n      t1.name,\n      t3.name AS city, t3.stateId,\n      t4.name AS state\n    FROM `"+s.Restaurante.tableName+"` t1\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t2 ON t2._id = t1._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t3 ON t3._id = t1.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t4 ON t4._id = t3.stateId\n    WHERE t2.active = 1\n    ORDER BY t1.visitas DESC\n    LIMIT :limit) x,\n  (SELECT @row := 0) y;",t.highlightQueryAdmin="SELECT @row := @row + 1 AS row, x.*\n  FROM (SELECT t1._id, t1.description, t1.image, t1.likes, t1.postalCode,\n      t1.telephone1, t1.telephone2, t1.visitas,\n      t1.address1, t1.address2,\n      t1.cityId, t1.keywords,\n      t1.horarioLunesApertura, t1.horarioLunesCierre,\n      t1.horarioMartesApertura, t1.horarioMartesCierre,\n      t1.horarioMiercolesApertura, t1.horarioMiercolesCierre,\n      t1.horarioJuevesApertura, t1.horarioJuevesCierre,\n      t1.horarioViernesApertura, t1.horarioViernesCierre,\n      t1.horarioSabadoApertura, t1.horarioSabadoCierre,\n      t1.horarioDomingoApertura, t1.horarioDomingoCierre,\n      t1.servicioDomicilio,\n      t1.name, t2.active,\n      t3.name AS city, t3.stateId,\n      t4.name AS state\n    FROM `"+s.Restaurante.tableName+"` t1\n    LEFT JOIN `"+s.MenuNodes.tableName+"` t2 ON t2._id = t1._id\n    LEFT JOIN `"+s.Ciudad.tableName+"` t3 ON t3._id = t1.cityId\n    LEFT JOIN `"+s.Estado.tableName+"` t4 ON t4._id = t3.stateId\n    ORDER BY t1.visitas DESC\n    LIMIT :limit) x,\n  (SELECT @row := 0) y;",t.addLeafQuery="INSERT INTO `"+s.MenuPaths.tableName+"` (parent, descendant, depth)\n  SELECT t.parent, :newNodeId, t.depth + 1\n    FROM `"+s.MenuPaths.tableName+"` t\n    WHERE t.descendant = :parentId\n  UNION ALL\n    SELECT :newNodeId, :newNodeId, 0;",t.deleteLeafAndDescendantsQuery="DELETE t1\nFROM `"+s.MenuNodes.tableName+"` t1\nJOIN `"+s.MenuPaths.tableName+"` t2 ON t2.descendant = t1._id\nWHERE t2.parent = :deletedNodeId;",t.disconnectSubtreeQuery="DELETE t1.* FROM `"+s.MenuPaths.tableName+"` t1\nJOIN `"+s.MenuPaths.tableName+"` t2 ON t1.descendant = t2.descendant\nJOIN `"+s.MenuPaths.tableName+"` t3 ON t1.parent = t3.parent\nWHERE t2.parent = :movedNodeId AND\n  t3.descendant = :movedNodeId AND\n  t3.parent != t3.descendant;",t.connectSubtreeQuery="INSERT INTO `"+s.MenuPaths.tableName+"` (parent, descendant, depth)\n  SELECT supertree.parent,\n    subtree.descendant,\n    IF(supertree.depth > subtree.depth,\n      supertree.depth + 1,\n      subtree.depth + 1) AS depth\n  FROM `"+s.MenuPaths.tableName+"` supertree\n  CROSS JOIN `"+s.MenuPaths.tableName+"` AS subtree\n  WHERE supertree.descendant = :parentNodeId\n  AND subtree.parent = :movedNodeId;",t.nodeCountQuery="SELECT COUNT(*) AS count\nFROM `"+s.MenuPaths.tableName+"`\nWHERE parent = :parentNodeId AND depth = :depth",t.getDescendantsBreadcrumbsQuery="SELECT d._id, d.tipo,\n  (CASE d.tipo\n    WHEN 'categoria' THEN t1.name\n    WHEN 'platillo' THEN t2.name\n    WHEN 'restaurante' THEN t3.name\n    ELSE NULL\n  END) AS name,\n  t1.position AS positionCategorias,\n  t2.position AS positionPlatillos, t2.description AS descripcionPlatillo,\n  t2.price, t2.image as imagenPlatillo,\n  t3.description,\n  t3.horarioLunesApertura, t3.horarioLunesCierre,\n  t3.horarioMartesApertura, t3.horarioMartesCierre,\n  t3.horarioMiercolesApertura, t3.horarioMiercolesCierre,\n  t3.horarioJuevesApertura, t3.horarioJuevesCierre,\n  t3.horarioViernesApertura, t3.horarioViernesCierre,\n  t3.horarioSabadoApertura, t3.horarioSabadoCierre,\n  t3.horarioDomingoApertura, t3.horarioDomingoCierre,\n  t3.servicioDomicilio,\n  t3.image, t3.likes, t3.postalCode, t3.telephone1, t3.telephone2, t3.visitas,\n  t3.address1, t3.address2,\n  t3.cityId, t3.keywords,\n  t4.name AS city, t4.stateId, t5.name AS state,\n  GROUP_CONCAT(crumbs.parent SEPARATOR '/') AS breadcrumbs\nFROM `"+s.MenuNodes.tableName+"` AS d\nJOIN `"+s.MenuPaths.tableName+"` AS p ON d._id = p.descendant\nJOIN `"+s.MenuPaths.tableName+"` AS crumbs ON crumbs.descendant = p.descendant\nLEFT JOIN `"+s.Categoria.tableName+"` AS t1 ON d._id = t1._id\nLEFT JOIN `"+s.Platillo.tableName+"` AS t2 ON d._id = t2._id\nLEFT JOIN `"+s.Restaurante.tableName+"` AS t3 ON d._id = t3._id\nLEFT JOIN `"+s.Ciudad.tableName+"` t4 ON t4._id = t3.cityId\nLEFT JOIN `"+s.Estado.tableName+"` t5 ON t5._id = t4.stateId\nWHERE p.parent = :nodeId AND d.active = 1\nGROUP BY d._id\nORDER BY breadcrumbs;",t.getDescendantsBreadcrumbsQueryAdmin="SELECT d._id, d.tipo,\n  (CASE d.tipo\n    WHEN 'categoria' THEN t1.name\n    WHEN 'platillo' THEN t2.name\n    WHEN 'restaurante' THEN t3.name\n    ELSE NULL\n  END) AS name, d.active,\n  t1.position AS positionCategorias,\n  t2.position AS positionPlatillos, t2.description AS descripcionPlatillo,\n  t2.price, t2.image as imagenPlatillo,\n  t3.description,\n  t3.horarioLunesApertura, t3.horarioLunesCierre,\n  t3.horarioMartesApertura, t3.horarioMartesCierre,\n  t3.horarioMiercolesApertura, t3.horarioMiercolesCierre,\n  t3.horarioJuevesApertura, t3.horarioJuevesCierre,\n  t3.horarioViernesApertura, t3.horarioViernesCierre,\n  t3.horarioSabadoApertura, t3.horarioSabadoCierre,\n  t3.horarioDomingoApertura, t3.horarioDomingoCierre,\n  t3.servicioDomicilio,\n  t3.image, t3.likes, t3.postalCode, t3.telephone1, t3.telephone2, t3.visitas,\n  t3.address1, t3.address2,\n  t3.cityId, t3.keywords,\n  t4.name AS city, t4.stateId, t5.name AS state,\n  GROUP_CONCAT(crumbs.parent SEPARATOR '/') AS breadcrumbs\nFROM `"+s.MenuNodes.tableName+"` AS d\nJOIN `"+s.MenuPaths.tableName+"` AS p ON d._id = p.descendant\nJOIN `"+s.MenuPaths.tableName+"` AS crumbs ON crumbs.descendant = p.descendant\nLEFT JOIN `"+s.Categoria.tableName+"` AS t1 ON d._id = t1._id\nLEFT JOIN `"+s.Platillo.tableName+"` AS t2 ON d._id = t2._id\nLEFT JOIN `"+s.Restaurante.tableName+"` AS t3 ON d._id = t3._id\nLEFT JOIN `"+s.Ciudad.tableName+"` t4 ON t4._id = t3.cityId\nLEFT JOIN `"+s.Estado.tableName+"` t5 ON t5._id = t4.stateId\nWHERE p.parent = :nodeId\nGROUP BY d._id\nORDER BY breadcrumbs;"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Platillo",{_id:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},name:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<o)throw new Error("Deben de ser cuando menos "+o+" caracteres")},maxlength:function(e){if(e&&e.length>s)throw new Error("Deben de ser máximo "+s+" caracteres")}}},description:{type:t.TEXT,validate:{notEmpty:{msg:"Requerido"}}},image:{type:t.STRING,defaultValue:""},price:{type:"NUMERIC(17, 2)",defaultValue:0,validate:{min:{args:a,msg:"El precio del platillo no puede ser menor a $0.00"},max:{args:i,msg:"El precio del platillo no puede ser mayor a $"+i},validNumber:function(e){if(e&&!/^(([0-9]{0,15}.[0-9]{0,2})|([0-9]{0,15}))$/.test(e))throw new Error("El precio '"+e+"' no es válido")}}},position:{type:t.INTEGER.UNSIGNED,defaultValue:0}},{freezeTableName:!0,tableName:n})};var n="platillos",a="0.00",i="999999999999999.99",o=0,s=255},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Restaurante",{_id:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0},name:{type:t.STRING,defaultValue:"",unique:!0,validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<o)throw new Error("Deben de ser cuando menos "+o+" caracteres")},maxlength:function(e){if(e&&e.length>s)throw new Error("Deben de ser máximo "+s+" caracteres")},checkUnique:function(t,r){var n=this;if(t){var o=n._id||-1,s="SELECT _id\n              FROM `"+i+"`\n              WHERE\n                LOWER(name)=LOWER(:name)\n              LIMIT 1;";return e.query(s,{replacements:{name:t},type:a.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]&&e[0]._id&&e[0]._id!==o?r("Este restaurante ya está registrado"):r()}).catch(function(e){return r(e)})}return r()},checkValid:function(e){if(e&&e.includes("_"))throw new Error("No está permitido utilizar guión bajo")}}},description:{type:t.TEXT,validate:{notEmpty:{msg:"Requerido"}}},keywords:{type:t.TEXT},image:{type:t.STRING,defaultValue:"defaultRestaurant.jpg"},cityId:{type:t.INTEGER.UNSIGNED,allowNull:!1,validate:{checkState:function(t,r){if(!t)return r("La ciudad es requerida");if(-1===t||"-1"===t)return r("Es necesario seleccionar una ciudad");e.query("SELECT _id\n              FROM `ciudades`\n              WHERE _id = :id AND deletedAt IS NULL\n              LIMIT 1;",{replacements:{id:t},type:a.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]?r():r("Esta ciudad aún no está dada de alta")})}}},telephone1:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"},is:{args:/^[0-9]{3}\s[0-9]{3}\s[0-9]{4}$/,msg:"Formato de teléfono inválido: ### ### ####"}}},telephone2:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"},is:{args:/(^[0-9]{3}\s[0-9]{3}\s[0-9]{4}$)|(^$)/,msg:"Formato de teléfono inválido: ### ### ####"}}},address1:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},address2:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},postalCode:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,5],msg:"Deben de ser máximo 5 caracteres"},is:{args:/^[0-9]{5}$/,msg:"Formato de código postal inválido: #####"}}},horarioLunesApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioLunesCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioMartesApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioMartesCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioMiercolesApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioMiercolesCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioJuevesApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioJuevesCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioViernesApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioViernesCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioSabadoApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioSabadoCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioDomingoApertura:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},horarioDomingoCierre:{type:t.STRING(8),defaultValue:"",validate:{len:{args:[0,8],msg:"Deben de ser máximo 8 caracteres"},is:{args:/^[0-1][0-9]:[0-5][0-9] (a|p)m/,msg:"Formato de horario inválido: hh:mm aa"}}},visitas:{type:t.BIGINT.UNSIGNED,defaultValue:0},likes:{type:t.BIGINT.UNSIGNED,defaultValue:0},servicioDomicilio:{type:t.BOOLEAN,defaultValue:!1}},{indexes:[{type:"FULLTEXT",name:"text_idx",fields:["name","description","keywords"]}],hooks:{beforeValidate:function(e){e.description=e.description||"",e.keywords=e.keywords||""},beforeCreate:function(e){e.description=e.description||"",e.keywords=e.keywords||""},beforeUpdate:function(e){e.description=e.description||"",e.keywords=e.keywords||""},beforeSave:function(e){e.description=e.description||"",e.keywords=e.keywords||""}},freezeTableName:!0,tableName:i})};var n=r(4),a=function(e){return e&&e.__esModule?e:{default:e}}(n),i="restaurantes",o=0,s=255},function(e,t,r){"use strict";var n=r(2),a=r(31),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(a),o=new n.Router;o.get("/",i.select),o.post("/",i.solicitar),o.put("/",i.recuperar),e.exports=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!e.query||!e.query.usuario)return void t.status(400).end();s.sequelize.query(p,{type:s.Sequelize.QueryTypes.SELECT,replacements:{id:e.query.usuario}}).then(function(e){return e&&e[0]?e[0]:null}).then((0,u.handleEntityNotFound)(t)).then((0,u.respondWithResult)(t)).catch((0,u.handleError)(t))}function i(e,t){var r=e.body.email;return s.sequelize.transaction(function(e){return s.User.findOne({where:{email:r,deletedAt:null},lock:e.LOCK.SHARE,transaction:e}).then(function(r){return r?s.Recuperacion.findOne({where:{userId:r._id,createdAt:{$gte:s.sequelize.literal("DATE_SUB(NOW(), INTERVAL 5 MINUTE)")}},transaction:e}).then(function(n){return n?(t.status(429).end(),null):s.Recuperacion.create({userId:r._id},{transaction:e})}):(t.status(404).end(),null)})}).then(function(e){return e?(t.status(201).end(),e):null}).then(function(e){if(e){var t={from:h.default.smtp.from,to:r,subject:"Mis restaurantes: Recuperación de contraseña",text:"Hemos recibido una solicitud para recuperación de contraseña\n\nPara continuar con el proceso accede al siguiente vínculo:\n"+h.default.baseUrl+"/recuperacion/codigo?usuario="+e._id+"\n\nSi tienes problemas para entrar al vínculo, copialo y pégalo en la barra de búsqueda del navegador\n\nSi no solicitaste la recuperación de contraseña, ignora este correo. El código de recuperación caduca en 24 horas"};return(0,l.default)(t)}return null}).catch((0,u.handleError)(t))}function o(e,t){if(!e.query||!e.query.usuario)return void t.status(400).end();var r=e.body.password;return s.sequelize.transaction(function(t){return s.Recuperacion.findOne({where:{_id:e.query.usuario,createdAt:{$gte:s.sequelize.literal("DATE_SUB(NOW(), INTERVAL 1 DAY)")},usedAt:null},lock:t.LOCK.UPDATE,transaction:t}).then(function(e){return e?e.update({usedAt:s.sequelize.literal("NOW()")},{transaction:t}).then(function(){return e}):null}).then(function(e){return e?s.User.findOne({where:{_id:e.userId},lock:t.LOCK.UPDATE,transaction:t}):null}).then(function(e){return e?e.update({password:r},{transaction:t}).then(function(){return e}):null})}).then((0,u.handleEntityNotFound)(t)).then(function(e){return e?t.status(201).end():null}).catch((0,u.validationError)(t))}Object.defineProperty(t,"__esModule",{value:!0}),t.select=a,t.solicitar=i,t.recuperar=o;var s=r(1),u=r(3),d=r(9),l=n(d),c=r(0),h=n(c),p="SELECT\n  t1.userId, t2.email\nFROM "+s.Recuperacion.tableName+" t1\nLEFT JOIN "+s.User.tableName+" t2 ON t2._id = t1.userId\nWHERE t1._id = :id AND\n  t1.usedAt IS NULL AND\n  t1.createdAt >= DATE_SUB(NOW(), INTERVAL 1 DAY)\nLIMIT 1;"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Recuperacion",{_id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},userId:{type:t.BIGINT.UNSIGNED,allowNull:!1},createdAt:{type:t.DATE,defaultValue:t.NOW},usedAt:t.DATE},{freezeTableName:!0,tableName:n})};var n="recuperaciones"},function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var a=r(2),i=r(34),o=n(i),s=r(5),u=n(s),d=r(3),l=new a.Router;l.get("/nuevo",o.activate),l.get("/",u.hasRole("admin"),o.index),l.delete("/:id",u.hasRole("admin"),(0,d.checkIdFromParams)("id"),(0,d.checkIfErrors)(),o.destroy),l.patch("/:id",u.hasRole("admin"),(0,d.checkIdFromParams)("id"),(0,d.checkIfErrors)(),o.revive),l.put("/:id/admin",u.hasRole("admin"),(0,d.checkIdFromParams)("id"),(0,d.checkIfErrors)(),o.updateRole),l.get("/me",u.isAuthenticated(),o.me),l.put("/settings",u.isAuthenticated(),o.settings),l.get("/:id",u.isAuthenticated(),(0,d.checkIdFromParams)("id"),(0,d.checkIfErrors)(),o.show),l.post("/",o.create),e.exports=l},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){E.sequelize.query(A,{type:E.Sequelize.QueryTypes.SELECT}).then((0,y.respondWithResult)(t)).catch((0,y.handleError)(t))}function i(e,t){var r=E.NewUser.build(e.body);return r.setDataValue("provider","local"),r.setDataValue("role","usuario"),r.save().then(function(e){return t.status(201).end(),e}).then(function(e){var t={from:v.default.smtp.from,to:e.email,subject:"Mis Restaurantes: Nueva cuenta",text:"¡Te damos la bienvenida a Mis Restaurantes!\n\nPara completar tu registro sólo es necesario que entres al siguiente vínculo:\n"+v.default.baseUrl+"/nuevo?usuario="+e._id+"\n\nSi tienes problemas para entrar al vínculo, copialo y pégalo en la barra de búsqueda del navegador\n\nSi no te registraste en Mis Restaurantes, ignora este correo. El código de activación caduca en 24 horas"};return(0,I.default)(t)}).catch((0,y.validationError)(t))}function o(e,t){return e.query&&e.query.usuario?E.sequelize.transaction(function(t){return E.NewUser.findOne({where:{_id:e.query.usuario,createdAt:{$gte:E.sequelize.literal("DATE_SUB(NOW(), INTERVAL 1 DAY)")},usedAt:null},lock:t.LOCK.UPDATE,transaction:t}).then(function(e){return e?E.User.create({name:e.name,email:e.email,role:e.role,password:e.password,provider:e.provider,salt:e.salt,address1:e.address1,address2:e.address2,city:e.city,state:e.state,postalCode:e.postalCode},{transaction:t,validate:!1}).then(function(r){return e.update({usedAt:E.sequelize.literal("NOW()")},{transaction:t})}):null})}).then((0,y.handleEntityNotFound)(t)).then(function(e){return e?t.status(201).end():null}).catch((0,y.handleError)(t)):void t.status(400).end()}function s(e,t){var r=e.params.id;E.sequelize.query(_,{replacements:{id:r},type:E.Sequelize.QueryTypes.SELECT}).then((0,y.handleEntityNotFound)(t)).then((0,y.respondWithResult)(t)).catch((0,y.handleError)(t))}function u(e,t){var r=e.params.id,n=new Date;return E.User.findOne({where:{_id:r,deletedAt:null}}).then(function(r){if(r){if("admin"===r.role)return t.status(403).send([{message:"No es posible desactivar un usuario administrador",type:"Authorization error",path:"role",value:"admin",raw:{}}]),null;var a=m.default.cloneDeep(r);return r.update({editorId:e.user._id,deletedAt:n}).then(function(){return a})}return null}).then((0,y.handleEntityNotFound)(t)).then((0,y.respondWithResult)(t)).catch((0,y.handleError)(t))}function d(e,t){var r=e.params.id;return E.User.findOne({where:{_id:r,deletedAt:{$ne:null}}}).then(function(t){if(t){var r=m.default.cloneDeep(t);return t.update({editorId:e.user._id,deletedAt:null}).then(function(){return r})}return null}).then((0,y.handleEntityNotFound)(t)).then((0,y.respondWithResult)(t)).catch((0,y.handleError)(t))}function l(e,t){var r=e.params.id,n=e.body.role;return E.User.findOne({where:{_id:r,deletedAt:null}}).then(function(e){return e?(e.role=n,e.save()):null}).then(function(e){return e?{_id:e._id,email:e.email,provider:e.provider,role:e.role,deleted:null!==e.deletedAt}:null}).then((0,y.handleEntityNotFound)(t)).then((0,y.respondWithResult)(t,200)).catch((0,y.validationError)(t))}function c(e,t){var r=e.user._id,n=String(e.body.password),a=String(e.body.newPassword),i=new Date;return E.sequelize.transaction(function(o){return E.User.findOne({where:{_id:r,email:e.body.email,deletedAt:null},lock:o.LOCK.UPDATE,transaction:o}).then((0,y.handleEntityNotFound)(t)).then(function(s){return s?s.authenticate(n).then(function(n){return n?s.update({name:e.body.name||s.name,password:a||s.password,address1:e.body.address1||s.address1,address2:e.body.address2||s.address2,city:e.body.city||s.city,state:e.body.state||s.state,postalCode:e.body.postalCode||s.postalCode,editorId:r,updatedAt:i},{transaction:o}).then(function(){return{email:s.email}}):(t.status(401).end(),null)}):null})}).then((0,y.respondWithResult)(t)).then((0,y.handleError)(t))}function h(e,t){var r=e.user._id;return E.sequelize.query(T,{replacements:{id:r},type:E.Sequelize.QueryTypes.SELECT}).then((0,y.handleEntityNotFound)(t)).then((0,y.respondWithResult)(t)).catch((0,y.handleError)(t))}function p(e,t){t.redirect("/")}Object.defineProperty(t,"__esModule",{value:!0}),t.index=a,t.create=i,t.activate=o,t.show=s,t.destroy=u,t.revive=d,t.updateRole=l,t.settings=c,t.me=h,t.authCallback=p;var f=r(6),m=n(f),E=r(1),y=r(3),N=r(9),I=n(N),g=r(0),v=n(g),A="SELECT\n  _id, email, role, provider, IF(deletedAt IS NULL, FALSE, TRUE) AS deleted\nFROM "+E.User.tableName+";",_="SELECT\n  _id, email, role, provider, createdAt, updatedAt, deletedAt\nFROM "+E.User.tableName+"\nWHERE _id = :id AND deletedAt IS NULL;",T="SELECT\n  _id, email, role, provider\nFROM "+E.User.tableName+"\nWHERE _id = :id AND deletedAt IS NULL;"},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var r=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16;return new Promise(function(t,r){i.default.randomBytes(e,function(e,n){e&&r(e),t(n.toString("base64"))})})},n=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:64,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"sha512",o=new Buffer(t,"base64");return new Promise(function(t,s){i.default.pbkdf2(e,o,r,n,a,function(e,r){e&&s(e),t(r.toString("base64"))})})},a=e.define("User",{_id:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0,autoIncrement:!0},name:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},email:{type:t.STRING,defaultValue:"",unique:{msg:"El email ya está en uso"},validate:{checkUnique:function(t,r){var n=this;if(t){var a=n._id||-1,i="SELECT _id\n              FROM `"+l+"`\n              WHERE email = :email\n              LIMIT 1;";return e.query(i,{replacements:{email:t},type:d.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]&&e[0]._id&&e[0]._id!==a?r("Este email ya está en uso"):r()}).catch(function(e){return r(e)})}return r()},isEmail:{msg:"Email inválido"},len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"},notEmpty:{msg:"Requerido"}}},role:{type:t.STRING,defaultValue:"usuario",validate:{isIn:{args:[s.default.roles],msg:"El rol del usuario no es válido"}}},password:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<c)throw new Error("Deben de ser cuando menos "+c+" caracteres")},maxlength:function(e){if(e&&e.length>h)throw new Error("Deben de ser máximo "+h+" caracteres")}}},provider:t.STRING,salt:t.STRING,address1:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},address2:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},city:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},state:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},postalCode:{type:t.STRING,defaultValue:"",validate:{is:{args:/^$|^[0-9]{5}$/,msg:"El código postal no parece ser válido"}}},editorId:t.BIGINT.UNSIGNED,createdAt:{type:t.DATE,defaultValue:t.NOW},updatedAt:{type:t.DATE},deletedAt:{type:t.DATE}},{getterMethods:{profile:function(){return{_id:this._id,name:this.name,role:this.role}}},hooks:{beforeValidate:function(e,t){e.password=e.password||""},beforeUpdate:function(e,t){if(e.email=e.email.toLowerCase(),e.changed("password"))return t.validate=!1,e.updatePassword()}},freezeTableName:!0,tableName:l});return a.prototype.authenticate=function(e){var t=this;return n(e,this.salt).then(function(e){return e===t.password})},a.prototype.updatePassword=function(){var e=this;if(this.password)return r().then(function(t){return e.salt=t,n(e.password,e.salt)}).then(function(t){e.password=t})},a};var a=r(10),i=n(a),o=r(0),s=n(o),u=r(4),d=n(u),l="users",c=4,h=20},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var r=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16;return new Promise(function(t,r){i.default.randomBytes(e,function(e,n){e&&r(e),t(n.toString("base64"))})})},n=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:64,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"sha512",o=new Buffer(t,"base64");return new Promise(function(t,s){i.default.pbkdf2(e,o,r,n,a,function(e,r){e&&s(e),t(r.toString("base64"))})})},a=e.define("NewUser",{_id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},name:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},email:{type:t.STRING,defaultValue:"",validate:{checkUnique:function(t,r){var n=this;if(t){var a=n._id||-1,i="SELECT _id\n              FROM `users`\n              WHERE email = :email\n              UNION ALL\n              SELECT _id\n              FROM `"+l+"`\n              WHERE email = :email AND\n              createdAt >= DATE_SUB(NOW(), INTERVAL 1 DAY) AND\n              usedAt IS NULL\n              LIMIT 1;";return e.query(i,{replacements:{email:t},type:d.default.QueryTypes.SELECT}).then(function(e){return e&&e[0]&&e[0]._id&&e[0]._id!==a?r("Este email ya está en uso"):r()}).catch(function(e){return r(e)})}return r()},isEmail:{msg:"Email inválido"},len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"},notEmpty:{msg:"Requerido"}}},role:{type:t.STRING,defaultValue:"usuario",validate:{isIn:{args:[s.default.roles],msg:"El rol del usuario no es válido"}}},password:{type:t.STRING,defaultValue:"",validate:{notEmpty:{msg:"Requerido"},minlength:function(e){if(e&&e.length<c)throw new Error("Deben de ser cuando menos "+c+" caracteres")},maxlength:function(e){if(e&&e.length>h)throw new Error("Deben de ser máximo "+h+" caracteres")}}},provider:t.STRING,salt:t.STRING,address1:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},address2:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},city:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},state:{type:t.STRING,defaultValue:"",validate:{len:{args:[0,255],msg:"Deben de ser máximo 255 caracteres"}}},postalCode:{type:t.STRING,defaultValue:"",validate:{is:{args:/^$|^[0-9]{5}$/,msg:"El código postal no parece ser válido"}}},createdAt:{type:t.DATE,defaultValue:t.NOW},usedAt:{type:t.DATE}},{getterMethods:{profile:function(){return{_id:this._id,name:this.name,role:this.role}}},hooks:{beforeCreate:function(e,t){return e.email=e.email.toLowerCase(),e.updatePassword()}},freezeTableName:!0,tableName:l});return a.prototype.authenticate=function(e){var t=this;return n(e,this.salt).then(function(e){return e===t.password})},a.prototype.updatePassword=function(){var e=this;if(this.password)return r().then(function(t){return e.salt=t,n(e.password,e.salt)}).then(function(t){e.password=t})},a};var a=r(10),i=n(a),o=r(0),s=n(o),u=r(4),d=n(u),l="new-users",c=4,h=20},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.define("Visita",{_id:{type:t.INTEGER.UNSIGNED,allowNull:!1,primaryKey:!0,autoIncrement:!0},ip:{type:t.STRING},restauranteId:{type:t.BIGINT.UNSIGNED,allowNull:!1,primaryKey:!0}},{freezeTableName:!0,tableName:n})};var n="visitas"},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(2),i=n(a),o=r(0),s=n(o),u=r(1);r(40).setup(u.User,s.default);var d=i.default.Router();d.use("/local",r(39).default),t.default=d},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(2),i=n(a),o=r(11),s=n(o),u=r(5),d=i.default.Router();d.post("/",function(e,t,r){s.default.authenticate("local",function(e,r,n){var a=e||n;if(a)return t.status(401).json(a);if(!r)return t.status(404).json({message:"Algo salio mal, favor de intentarlo nuevamente"});var i=(0,u.signToken)(r._id,r.role);t.json({token:i})})(e,t,r)}),t.default=d},function(e,t,r){"use strict";function n(e,t,r,n){e.findOne({where:{email:t.toLowerCase(),deletedAt:null}}).then(function(e){if(!e)return n(null,!1,{message:"Usuario y/o contraseña incorrectos"});e.authenticate(r).then(function(t){return t?n(null,e):n(null,!1,{message:"Usuario y/o contraseña incorrectos"})})}).catch(function(e){return n(e)})}function a(e){o.default.use(new s.Strategy({usernameField:"email",passwordField:"password"},function(t,r,a){return n(e,t,r,a)}))}Object.defineProperty(t,"__esModule",{value:!0}),t.setup=a;var i=r(11),o=function(e){return e&&e.__esModule?e:{default:e}}(i),s=r(62)},function(e,t,r){"use strict";e.exports={sequelize:{user:process.env.DATABASE_USER_DEVELOPMENT,password:process.env.DATABASE_PASSWORD_DEVELOPMENT,address:process.env.DATABASE_ADDRESS_DEVELOPMENT,name:process.env.DATABASE_NAME_DEVELOPMENT,options:{dialectOptions:{multipleStatements:!0},logging:console.log,define:{timestamps:!1}}},smtp:{credentials:{user:process.env.SMTP_USER_DEVELOPMENT,pass:process.env.SMTP_PASSWORD_DEVELOPMENT},from:process.env.SMTP_FROM_DEVELOPMENT},baseUrl:process.env.BASE_URL+":"+(80===process.env.PORT?"":process.env.PORT)}},function(e,t,r){"use strict";e.exports={sequelize:{user:process.env.DATABASE_USER_PRODUCTION,password:process.env.DATABASE_PASSWORD_PRODUCTION,address:process.env.DATABASE_ADDRESS_PRODUCTION,name:process.env.DATABASE_NAME_PRODUCTION,options:{dialectOptions:{multipleStatements:!0},logging:!1,define:{timestamps:!1}}},smtp:{credentials:{user:process.env.SMTP_USER_PRODUCTION,pass:process.env.SMTP_PASSWORD_PRODUCTION},from:process.env.SMTP_FROM_PRODUCTION},baseUrl:process.env.BASE_URL}},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){e.use((0,y.default)());var t=new Date(Date.now()+36e5);e.use((0,c.default)({name:"session",keys:[process.env.SESSION_KEY_1,process.env.SESSION_KEY_2,process.env.SESSION_KEY_3],cookie:{httpOnly:!0,expires:t}})),e.set("appPath",p.default.resolve("dist")),e.use(i.default.static(e.get("appPath"))),"production"!==g&&e.use((0,m.default)("dev")),e.engine("html",r(54).renderFile),e.set("view engine","html"),e.use(s.default.urlencoded({extended:!1})),e.use(s.default.json()),e.use((0,d.default)()),"production"===g&&(e.use((0,I.default)({cookie:{sameSite:!0,httpOnly:!0}})),e.use(function(e,t,r){t.cookie("XSRF-TOKEN",e.csrfToken()),r()}))};var a=r(2),i=n(a),o=r(47),s=n(o),u=r(50),d=n(u),l=r(51),c=n(l),h=r(7),p=n(h),f=r(59),m=n(f),E=r(56),y=n(E),N=r(52),I=n(N),g=process.env.NODE_ENV||"development"},function(e,t,r){"use strict";var n=process.env.NODE_ENV||"development";"development"!==n&&"test"!==n||r(13),e.exports=r(12)},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){e.use("/api/users",r(33)),e.use("/api/recuperacion",r(30)),e.use("/api/restaurantes",r(21)),e.use("/api/ciudades",r(16)),e.use("/api/estados",r(19)),e.use("/auth",r(38).default),e.use("/static",s.default.static(i.default.join(__dirname,"public"))),e.use("/manifest.json",s.default.static(i.default.join(__dirname,"/../favicons","manifest.json"))),e.use("/android-chrome-192x192.png",s.default.static(i.default.join(__dirname,"/../favicons","android-chrome-192x192.png"))),e.use("/android-chrome-256x256.png",s.default.static(i.default.join(__dirname,"/../favicons","android-chrome-256x256.png"))),e.use("/android-chrome-512x512.png",s.default.static(i.default.join(__dirname,"/../favicons","android-chrome-512x512.png"))),e.use("/apple-touch-icon.png",s.default.static(i.default.join(__dirname,"/../favicons","apple-touch-icon.png"))),e.use("/browserconfig.xml",s.default.static(i.default.join(__dirname,"/../favicons","browserconfig.xml"))),e.use("/favicon.ico",s.default.static(i.default.join(__dirname,"/../favicons","favicon.ico"))),e.use("/favicon-16x16.png",s.default.static(i.default.join(__dirname,"/../favicons","favicon-16x16.png"))),e.use("/favicon-32x32.png",s.default.static(i.default.join(__dirname,"/../favicons","favicon-32x32.png"))),e.use("/mstile-150x150.png",s.default.static(i.default.join(__dirname,"/../favicons","mstile-150x150.png"))),e.use("/safari-pinned-tab.svg",s.default.static(i.default.join(__dirname,"/../favicons","safari-pinned-tab.svg"))),e.route("/:url(api/auth/components/app/node_components/assets)/*").get(function(e,t){return t.status(404).end()}),e.route("/*").get(function(t,r){r.sendFile(i.default.resolve(e.get("appPath")+"/index.html"))})};var a=r(7),i=n(a),o=r(2),s=n(o)},function(e,t,r){function n(e){return r(a(e))}function a(e){var t=i[e];if(!(t+1))throw new Error("Cannot find module '"+e+"'.");return t}var i={"./development.js":41,"./index.js":0,"./production.js":42,"./shared.js":8};n.keys=function(){return Object.keys(i)},n.resolve=a,e.exports=n,n.id=46},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cloudinary")},function(e,t){e.exports=require("composable-middleware")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("cookie-session")},function(e,t){e.exports=require("csurf")},function(e,t){e.exports=require("datauri")},function(e,t){e.exports=require("ejs")},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("passport-local")}]);